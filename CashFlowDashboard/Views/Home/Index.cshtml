@model CashFlowDashboard.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="flex flex-col gap-6">
    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 lg:gap-6">
        <!-- Card 1 -->
        <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-subtle hover:shadow-card transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
                    <span class="material-symbols-outlined text-green-600 dark:text-green-400">account_balance</span>
                </div>
                <span class="flex items-center text-xs font-bold text-green-600 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-full">@Model.BalanceChangePercent.ToString("P1")</span>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Total Cash Balance</p>
            <h3 class="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">@Model.CurrentBalance.ToString("C0")</h3>
        </div>
        <!-- Card 2 -->
        <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-subtle hover:shadow-card transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-primary/10 rounded-lg">
                    <span class="material-symbols-outlined text-primary">payments</span>
                </div>
                <span class="flex items-center text-xs font-bold text-slate-500 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full">Last 30d</span>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Net Cash Flow</p>
            <h3 class="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">@Model.NetCashFlow30Day.ToString("C0")</h3>
        </div>
        <!-- Card 3 -->
        <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-subtle hover:shadow-card transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                    <span class="material-symbols-outlined text-purple-600 dark:text-purple-400">trending_up</span>
                </div>
                <span class="flex items-center text-xs font-bold text-purple-600 bg-purple-50 dark:bg-purple-900/20 px-2 py-1 rounded-full">Projected</span>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Forecast Growth</p>
            <h3 class="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">@Model.ForecastGrowth60Day.ToString("P1")</h3>
        </div>
        <!-- Card 4 -->
        <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-subtle hover:shadow-card transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-red-50 dark:bg-red-900/20 rounded-lg">
                    <span class="material-symbols-outlined text-red-600 dark:text-red-400">warning</span>
                </div>
                <span class="flex items-center text-xs font-bold text-red-600 bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded-full">Action Needed</span>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Active Alerts</p>
            <h3 class="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">@Model.ActiveAlertCount Items</h3>
        </div>
    </div>

    <!-- Complex Grid Layout for Charts & Lists -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 h-full">
        <!-- Main Chart Area (2/3 width) -->
        <div class="xl:col-span-2 bg-surface-light dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-subtle flex flex-col">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                <div>
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Cash Flow Analysis</h3>
                    <p class="text-sm text-slate-500">Inflow vs Outflow over the last 6 months</p>
                </div>
                <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg self-start">
                    <button class="px-3 py-1.5 text-xs font-bold bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm rounded-md">6M</button>
                    <button class="px-3 py-1.5 text-xs font-medium text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">1Y</button>
                    <button class="px-3 py-1.5 text-xs font-medium text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">All</button>
                </div>
            </div>
            <!-- Chart Container -->
            <div class="flex-1 w-full min-h-[300px] relative">
                <canvas id="cashFlowChart"></canvas>
            </div>
            <!-- X Axis Labels (handled by Chart.js) -->
        </div>

        <!-- Right Column (1/3 width) - Stacked -->
        <div class="flex flex-col gap-6">
            <!-- Mini Forecast Chart -->
            <div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-subtle">
                <h4 class="text-base font-bold text-slate-900 dark:text-white mb-4">Q3 Forecast Preview</h4>
                <div class="flex items-end justify-between h-[160px] gap-2 px-2">
                    <div class="w-full flex flex-col justify-end gap-2 group cursor-pointer">
                        <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-t-sm h-[40%] group-hover:bg-slate-200 transition-colors relative"></div>
                        <div class="w-full bg-primary rounded-t-sm h-[30%] group-hover:bg-primary-dark transition-colors"></div>
                        <span class="text-xs text-center text-slate-400 font-medium">Jul</span>
                    </div>
                    <div class="w-full flex flex-col justify-end gap-2 group cursor-pointer">
                        <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-t-sm h-[60%] group-hover:bg-slate-200 transition-colors"></div>
                        <div class="w-full bg-primary rounded-t-sm h-[80%] group-hover:bg-primary-dark transition-colors relative">
                            <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Goal Met</div>
                        </div>
                        <span class="text-xs text-center text-slate-400 font-medium">Aug</span>
                    </div>
                    <div class="w-full flex flex-col justify-end gap-2 group cursor-pointer">
                        <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-t-sm h-[45%] group-hover:bg-slate-200 transition-colors"></div>
                        <div class="w-full bg-primary rounded-t-sm h-[50%] group-hover:bg-primary-dark transition-colors"></div>
                        <span class="text-xs text-center text-slate-400 font-medium">Sep</span>
                    </div>
                </div>
                <div class="mt-4 flex gap-4 justify-center text-xs text-slate-500">
                    <div class="flex items-center gap-1.5">
                        <div class="w-2 h-2 rounded-full bg-primary"></div> Actuals
                    </div>
                    <div class="flex items-center gap-1.5">
                        <div class="w-2 h-2 rounded-full bg-slate-200 dark:bg-slate-600"></div> Projected
                    </div>
                </div>
            </div>

            <!-- Alerts & Notifications Panel -->
            <div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-slate-800 p-0 shadow-subtle flex-1 flex flex-col overflow-hidden">
                <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                    <h4 class="text-base font-bold text-slate-900 dark:text-white">Recent Alerts</h4>
                    <button class="text-xs text-primary font-bold hover:underline">View All</button>
                </div>
                <div class="flex-1 overflow-y-auto p-2">
                    @if (Model.RecentAlerts.Any())
                    {
                        @foreach (var alert in Model.RecentAlerts)
                        {
                            var iconColor = alert.Severity switch
                            {
                                CashFlowDashboard.Models.Enums.AlertSeverity.Critical => "text-red-500 bg-red-100 dark:bg-red-900/30",
                                CashFlowDashboard.Models.Enums.AlertSeverity.Warning => "text-amber-500 bg-amber-100 dark:bg-amber-900/30",
                                _ => "text-blue-500 bg-blue-100 dark:bg-blue-900/30"
                            };
                            var icon = alert.Severity switch
                            {
                                CashFlowDashboard.Models.Enums.AlertSeverity.Critical => "priority_high",
                                CashFlowDashboard.Models.Enums.AlertSeverity.Warning => "warning",
                                _ => "info"
                            };
                            <div class="flex gap-3 p-3 hover:bg-slate-50 dark:hover:bg-slate-800/50 rounded-lg transition-colors cursor-pointer group">
                                <div class="mt-1 flex-shrink-0">
                                    <span class="material-symbols-outlined @iconColor text-sm p-1.5 rounded-full">@icon</span>
                                </div>
                                <div class="flex flex-col gap-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <p class="text-sm font-semibold text-slate-800 dark:text-slate-200 truncate group-hover:text-primary transition-colors">@alert.Title</p>
                                        <span class="text-[10px] text-slate-400 whitespace-nowrap">@alert.TimeAgo</span>
                                    </div>
                                    <p class="text-xs text-slate-500 line-clamp-1">@alert.Message</p>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="p-6 text-center text-slate-400">
                            <p class="text-sm">No recent alerts</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Serialize server-side Model data to JavaScript
    const chartData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.HistoricalChartData));
    const projectedData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProjectedChartData));

    // Extract labels (dates) and dataset values
    const labels = chartData.map(point => {
        const date = new Date(point.Date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const balanceData = chartData.map(point => point.Balance);
    const incomeData = chartData.map(point => point.Income || 0);
    const expensesData = chartData.map(point => point.Expenses || 0);

    // Initialize Chart.js
    const ctx = document.getElementById('cashFlowChart').getContext('2d');
    const cashFlowChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Balance',
                    data: balanceData,
                    borderColor: '#266c73',
                    backgroundColor: 'rgba(38, 108, 115, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#266c73'
                },
                {
                    label: 'Income',
                    data: incomeData,
                    borderColor: '#10b981',
                    backgroundColor: 'transparent',
                    fill: false,
                    borderDash: [5, 5],
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4
                },
                {
                    label: 'Expenses',
                    data: expensesData,
                    borderColor: '#ef4444',
                    backgroundColor: 'transparent',
                    fill: false,
                    borderDash: [5, 5],
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 12,
                            family: 'Manrope'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.95)',
                    titleFont: {
                        size: 13,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', {
                                    style: 'currency',
                                    currency: 'USD',
                                    minimumFractionDigits: 0
                                }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11,
                            family: 'Manrope'
                        }
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(226, 232, 240, 0.3)',
                        drawBorder: false
                    },
                    ticks: {
                        font: {
                            size: 11,
                            family: 'Manrope'
                        },
                        callback: function(value) {
                            return new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD',
                                minimumFractionDigits: 0,
                                notation: 'compact',
                                compactDisplay: 'short'
                            }).format(value);
                        }
                    }
                }
            }
        }
    });
</script>
}
